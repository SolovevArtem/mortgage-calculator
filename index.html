<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ò–ø–æ—Ç–µ—á–Ω—ã–π –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0A0E27;
            --bg-secondary: #151B3D;
            --bg-card: #1C2447;
            --accent-primary: #00D9FF;
            --accent-secondary: #FF6B9D;
            --accent-tertiary: #FFD93D;
            --text-primary: #FFFFFF;
            --text-secondary: #94A3B8;
            --text-muted: #64748B;
            --border-color: rgba(0, 217, 255, 0.2);
            --shadow-glow: 0 0 30px rgba(0, 217, 255, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Manrope', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
            padding: 0;
            min-height: 100vh;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(0, 217, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(255, 107, 157, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(255, 217, 61, 0.05) 0%, transparent 50%);
            animation: gradientShift 20s ease infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes gradientShift {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(5%, 5%) rotate(180deg); }
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 20px 16px 100px;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 32px;
            animation: fadeInDown 0.6s ease;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header h1 {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }

        .card {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 24px;
            margin-bottom: 16px;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            animation: fadeInUp 0.6s ease;
            animation-fill-mode: both;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary), var(--accent-tertiary));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .card:hover::before {
            opacity: 1;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card:nth-child(2) { animation-delay: 0.1s; }
        .card:nth-child(3) { animation-delay: 0.2s; }
        .card:nth-child(4) { animation-delay: 0.3s; }
        .card:nth-child(5) { animation-delay: 0.4s; }

        .input-group {
            margin-bottom: 24px;
        }

        .input-group:last-child {
            margin-bottom: 0;
        }

        .input-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .input-label span {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .input-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 16px;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 8px;
            background: var(--bg-secondary);
            outline: none;
            position: relative;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 217, 255, 0.4);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .slider::-webkit-slider-thumb:active {
            transform: scale(1.2);
            box-shadow: 0 6px 20px rgba(0, 217, 255, 0.6);
        }

        .slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 217, 255, 0.4);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .slider::-moz-range-thumb:active {
            transform: scale(1.2);
            box-shadow: 0 6px 20px rgba(0, 217, 255, 0.6);
        }

        .input-hints {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 11px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        .result-card {
            background: linear-gradient(135deg, rgba(0, 217, 255, 0.1), rgba(255, 107, 157, 0.1));
            border: 2px solid var(--accent-primary);
            box-shadow: var(--shadow-glow);
        }

        .result-main {
            text-align: center;
            margin-bottom: 24px;
            padding: 16px 0;
        }

        .result-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 12px;
        }

        .result-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 48px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .result-currency {
            font-size: 24px;
            margin-left: 4px;
        }

        .result-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .result-item {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .result-item-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .result-item-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .result-item-value small {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .action-button {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 16px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: var(--text-primary);
            font-family: 'Manrope', sans-serif;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 8px 24px rgba(0, 217, 255, 0.3);
            position: relative;
            overflow: hidden;
        }

        .action-button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .action-button:active::before {
            width: 300px;
            height: 300px;
        }

        .action-button:active {
            transform: scale(0.98);
            box-shadow: 0 4px 12px rgba(0, 217, 255, 0.2);
        }

        .disclaimer {
            text-align: center;
            margin-top: 24px;
            padding: 16px;
            font-size: 11px;
            color: var(--text-muted);
            line-height: 1.6;
        }

        /* Analytics Badge */
        .analytics-badge {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 8px 12px;
            font-size: 10px;
            color: var(--text-muted);
            z-index: 1000;
            animation: fadeIn 1s ease 2s both;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .analytics-badge span {
            color: var(--accent-primary);
            font-weight: 700;
        }

        @media (max-width: 380px) {
            .header h1 {
                font-size: 28px;
            }

            .result-value {
                font-size: 40px;
            }

            .card {
                padding: 20px;
            }

            .analytics-badge {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ –ò–ø–æ—Ç–µ—á–Ω—ã–π<br>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</h1>
            <p>–†–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ –≤–∞—à –µ–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç—ë–∂</p>
        </div>

        <div class="card">
            <div class="input-group">
                <div class="input-label">
                    <span>–°—Ç–æ–∏–º–æ—Å—Ç—å –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</span>
                    <span class="input-value" id="priceValue">5 000 000 ‚ÇΩ</span>
                </div>
                <input type="range" min="1000000" max="30000000" value="5000000" step="100000" class="slider" id="price">
                <div class="input-hints">
                    <span>1M ‚ÇΩ</span>
                    <span>30M ‚ÇΩ</span>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="input-group">
                <div class="input-label">
                    <span>–ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π –≤–∑–Ω–æ—Å</span>
                    <span class="input-value" id="downPaymentValue">1 000 000 ‚ÇΩ</span>
                </div>
                <input type="range" min="0" max="10000000" value="1000000" step="50000" class="slider" id="downPayment">
                <div class="input-hints">
                    <span>0 ‚ÇΩ</span>
                    <span>10M ‚ÇΩ</span>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="input-group">
                <div class="input-label">
                    <span>–°—Ä–æ–∫ –∫—Ä–µ–¥–∏—Ç–∞</span>
                    <span class="input-value" id="termValue">15 –ª–µ—Ç</span>
                </div>
                <input type="range" min="1" max="30" value="15" step="1" class="slider" id="term">
                <div class="input-hints">
                    <span>1 –≥–æ–¥</span>
                    <span>30 –ª–µ—Ç</span>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="input-group">
                <div class="input-label">
                    <span>–ü—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞</span>
                    <span class="input-value" id="rateValue">12.0%</span>
                </div>
                <input type="range" min="5" max="25" value="12" step="0.1" class="slider" id="rate">
                <div class="input-hints">
                    <span>5%</span>
                    <span>25%</span>
                </div>
            </div>
        </div>

        <div class="card result-card">
            <div class="result-main">
                <div class="result-label">–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç—ë–∂</div>
                <div class="result-value">
                    <span id="monthlyPayment">48 049</span><span class="result-currency">‚ÇΩ</span>
                </div>
            </div>
            
            <div class="result-grid">
                <div class="result-item">
                    <div class="result-item-label">–°—É–º–º–∞ –∫—Ä–µ–¥–∏—Ç–∞</div>
                    <div class="result-item-value">
                        <span id="loanAmount">4.0</span> <small>–º–ª–Ω ‚ÇΩ</small>
                    </div>
                </div>
                <div class="result-item">
                    <div class="result-item-label">–ü–µ—Ä–µ–ø–ª–∞—Ç–∞</div>
                    <div class="result-item-value">
                        <span id="overpayment">4.65</span> <small>–º–ª–Ω ‚ÇΩ</small>
                    </div>
                </div>
                <div class="result-item">
                    <div class="result-item-label">–û–±—â–∞—è —Å—É–º–º–∞</div>
                    <div class="result-item-value">
                        <span id="totalAmount">8.65</span> <small>–º–ª–Ω ‚ÇΩ</small>
                    </div>
                </div>
                <div class="result-item">
                    <div class="result-item-label">–°—Ä–æ–∫</div>
                    <div class="result-item-value">
                        <span id="termMonths">180</span> <small>–º–µ—Å—è—Ü–µ–≤</small>
                    </div>
                </div>
            </div>
        </div>

        <button class="action-button" id="shareButton">
            –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–∞—Å—á—ë—Ç–æ–º
        </button>

        <div class="disclaimer">
            –†–∞—Å—á—ë—Ç —è–≤–ª—è–µ—Ç—Å—è –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–º. –¢–æ—á–Ω—ã–µ —É—Å–ª–æ–≤–∏—è —É—Ç–æ—á–Ω—è–π—Ç–µ –≤ –±–∞–Ω–∫–µ.
        </div>
    </div>

    <div class="analytics-badge">
        üìä –°–æ–±—ã—Ç–∏–π: <span id="eventCounter">0</span>
    </div>

    <script>
        // ============================================
        // ANALYTICS SYSTEM
        // ============================================
        
        class Analytics {
            constructor() {
                this.sessionId = this.generateSessionId();
                this.userId = null;
                this.startTime = Date.now();
                this.events = [];
                this.apiEndpoint = 'https://mortgage-calculator-z45v.onrender.com/api/analytics'; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à endpoint
                this.eventCounter = 0;
                
                this.init();
            }

            generateSessionId() {
                return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            init() {
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
                if (window.Telegram && window.Telegram.WebApp) {
                    const tgUser = window.Telegram.WebApp.initDataUnsafe.user;
                    if (tgUser) {
                        this.userId = tgUser.id;
                        this.userInfo = {
                            id: tgUser.id,
                            first_name: tgUser.first_name,
                            last_name: tgUser.last_name,
                            username: tgUser.username,
                            language_code: tgUser.language_code
                        };
                    }
                }

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                this.trackEvent('app_opened', {
                    platform: this.getPlatform(),
                    screen_width: window.innerWidth,
                    screen_height: window.innerHeight,
                    user_agent: navigator.userAgent
                });

                // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                window.addEventListener('beforeunload', () => {
                    this.trackEvent('app_closed', {
                        session_duration: Date.now() - this.startTime,
                        total_events: this.events.length
                    });
                    this.flush();
                });

                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
                setInterval(() => this.flush(), 30000);
            }

            getPlatform() {
                const ua = navigator.userAgent;
                if (ua.includes('iPhone') || ua.includes('iPad')) return 'iOS';
                if (ua.includes('Android')) return 'Android';
                if (ua.includes('Windows')) return 'Windows';
                if (ua.includes('Mac')) return 'macOS';
                return 'Unknown';
            }

            trackEvent(eventName, properties = {}) {
                const event = {
                    event_name: eventName,
                    timestamp: new Date().toISOString(),
                    session_id: this.sessionId,
                    user_id: this.userId,
                    properties: {
                        ...properties,
                        page_url: window.location.href,
                        referrer: document.referrer
                    }
                };

                this.events.push(event);
                this.eventCounter++;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫ –≤ UI
                const counter = document.getElementById('eventCounter');
                if (counter) {
                    counter.textContent = this.eventCounter;
                }

                // –õ–æ–≥–∏—Ä—É–µ–º –≤ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                console.log('üìä Analytics Event:', eventName, properties);

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram Analytics (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
                if (window.Telegram && window.Telegram.WebApp) {
                    try {
                        window.Telegram.WebApp.sendData(JSON.stringify({
                            type: 'analytics',
                            event: eventName,
                            properties: properties
                        }));
                    } catch (e) {
                        console.log('Telegram sendData not available');
                    }
                }

                // –ï—Å–ª–∏ –Ω–∞–∫–æ–ø–∏–ª–æ—Å—å –º–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏–π, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
                if (this.events.length >= 10) {
                    this.flush();
                }
            }

            async flush() {
                if (this.events.length === 0) return;

                const payload = {
                    session_id: this.sessionId,
                    user_id: this.userId,
                    user_info: this.userInfo,
                    events: [...this.events]
                };

                // –õ–æ–≥–∏—Ä—É–µ–º –≤ –∫–æ–Ω—Å–æ–ª—å (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
                console.log('üì§ Sending analytics:', payload);

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –¥–ª—è –±—ç–∫–∞–ø–∞
                try {
                    const stored = JSON.parse(localStorage.getItem('analytics_backup') || '[]');
                    stored.push(...this.events);
                    localStorage.setItem('analytics_backup', JSON.stringify(stored.slice(-100)));
                } catch (e) {
                    console.error('Failed to save analytics backup:', e);
                }

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                try {
                    // –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –∫–æ–≥–¥–∞ —É –≤–∞—Å –±—É–¥–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω endpoint
                    /*
                    await fetch(this.apiEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });
                    */
                    
                    // –û—á–∏—â–∞–µ–º –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
                    this.events = [];
                } catch (error) {
                    console.error('Failed to send analytics:', error);
                }
            }

            // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
            trackSliderChange(sliderName, value) {
                this.trackEvent('slider_changed', {
                    slider: sliderName,
                    value: value
                });
            }

            trackCalculation(params) {
                this.trackEvent('calculation_performed', params);
            }

            trackShare(method) {
                this.trackEvent('share_clicked', {
                    method: method
                });
            }

            trackTimeSpent(section, seconds) {
                this.trackEvent('time_spent', {
                    section: section,
                    duration_seconds: seconds
                });
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
        const analytics = new Analytics();

        // ============================================
        // MORTGAGE CALCULATOR
        // ============================================
        
        // Telegram WebApp initialization
        let tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // Elements
        const priceSlider = document.getElementById('price');
        const downPaymentSlider = document.getElementById('downPayment');
        const termSlider = document.getElementById('term');
        const rateSlider = document.getElementById('rate');

        const priceValue = document.getElementById('priceValue');
        const downPaymentValue = document.getElementById('downPaymentValue');
        const termValue = document.getElementById('termValue');
        const rateValue = document.getElementById('rateValue');

        const monthlyPaymentEl = document.getElementById('monthlyPayment');
        const loanAmountEl = document.getElementById('loanAmount');
        const overpaymentEl = document.getElementById('overpayment');
        const totalAmountEl = document.getElementById('totalAmount');
        const termMonthsEl = document.getElementById('termMonths');

        const shareButton = document.getElementById('shareButton');

        // Tracking variables
        let lastInteractionTime = Date.now();
        let calculationCount = 0;

        // Format number
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
        }

        // Calculate mortgage
        function calculateMortgage() {
            calculationCount++;
            
            const price = parseFloat(priceSlider.value);
            const downPayment = parseFloat(downPaymentSlider.value);
            const termYears = parseFloat(termSlider.value);
            const rate = parseFloat(rateSlider.value);

            // Update display values
            priceValue.textContent = formatNumber(price) + ' ‚ÇΩ';
            downPaymentValue.textContent = formatNumber(downPayment) + ' ‚ÇΩ';
            termValue.textContent = termYears + (termYears === 1 ? ' –≥–æ–¥' : termYears < 5 ? ' –≥–æ–¥–∞' : ' –ª–µ—Ç');
            rateValue.textContent = rate.toFixed(1) + '%';

            // Calculate loan
            const loanAmount = price - downPayment;
            const monthlyRate = rate / 100 / 12;
            const termMonths = termYears * 12;

            let monthlyPayment;
            if (monthlyRate === 0) {
                monthlyPayment = loanAmount / termMonths;
            } else {
                monthlyPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, termMonths)) / 
                                (Math.pow(1 + monthlyRate, termMonths) - 1);
            }

            const totalAmount = monthlyPayment * termMonths;
            const overpayment = totalAmount - loanAmount;

            // Update results
            monthlyPaymentEl.textContent = formatNumber(Math.round(monthlyPayment));
            loanAmountEl.textContent = (loanAmount / 1000000).toFixed(1);
            overpaymentEl.textContent = (overpayment / 1000000).toFixed(2);
            totalAmountEl.textContent = (totalAmount / 1000000).toFixed(2);
            termMonthsEl.textContent = termMonths;

            // Analytics
            analytics.trackCalculation({
                price: price,
                down_payment: downPayment,
                term_years: termYears,
                rate: rate,
                monthly_payment: Math.round(monthlyPayment),
                overpayment: Math.round(overpayment),
                calculation_number: calculationCount
            });

            // Haptic feedback
            if (tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
            }

            lastInteractionTime = Date.now();
        }

        // Event listeners with analytics
        priceSlider.addEventListener('input', (e) => {
            calculateMortgage();
            analytics.trackSliderChange('price', e.target.value);
        });

        downPaymentSlider.addEventListener('input', (e) => {
            calculateMortgage();
            analytics.trackSliderChange('down_payment', e.target.value);
        });

        termSlider.addEventListener('input', (e) => {
            calculateMortgage();
            analytics.trackSliderChange('term', e.target.value);
        });

        rateSlider.addEventListener('input', (e) => {
            calculateMortgage();
            analytics.trackSliderChange('rate', e.target.value);
        });

        // Share button with analytics
        shareButton.addEventListener('click', () => {
            if (tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('medium');
            }

            const price = parseFloat(priceSlider.value);
            const downPayment = parseFloat(downPaymentSlider.value);
            const termYears = parseFloat(termSlider.value);
            const rate = parseFloat(rateSlider.value);
            const monthlyPayment = monthlyPaymentEl.textContent;

            const message = `üí∞ –†–∞—Å—á—ë—Ç –∏–ø–æ—Ç–µ–∫–∏:\n\n` +
                          `üè† –°—Ç–æ–∏–º–æ—Å—Ç—å: ${formatNumber(price)} ‚ÇΩ\n` +
                          `üíµ –ü–µ—Ä–≤—ã–π –≤–∑–Ω–æ—Å: ${formatNumber(downPayment)} ‚ÇΩ\n` +
                          `üìÖ –°—Ä–æ–∫: ${termYears} ${termYears === 1 ? '–≥–æ–¥' : termYears < 5 ? '–≥–æ–¥–∞' : '–ª–µ—Ç'}\n` +
                          `üìä –°—Ç–∞–≤–∫–∞: ${rate.toFixed(1)}%\n\n` +
                          `‚úÖ –ü–ª–∞—Ç—ë–∂: ${monthlyPayment} ‚ÇΩ/–º–µ—Å`;

            // Try to use Telegram sharing
            if (tg.openTelegramLink) {
                const shareUrl = `https://t.me/share/url?url=${encodeURIComponent('https://t.me/your_bot')}&text=${encodeURIComponent(message)}`;
                tg.openTelegramLink(shareUrl);
                analytics.trackShare('telegram');
            } else if (navigator.share) {
                navigator.share({
                    title: '–†–∞—Å—á—ë—Ç –∏–ø–æ—Ç–µ–∫–∏',
                    text: message
                });
                analytics.trackShare('native');
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(message).then(() => {
                    tg.showAlert('–†–∞—Å—á—ë—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
                    analytics.trackShare('clipboard');
                });
            }
        });

        // Track time spent in app
        setInterval(() => {
            const timeSpent = Math.floor((Date.now() - lastInteractionTime) / 1000);
            if (timeSpent < 300) { // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–∫—Ç–∏–≤–µ–Ω (< 5 –º–∏–Ω—É—Ç –±–µ–∑ –¥–µ–π—Å—Ç–≤–∏–π)
                analytics.trackTimeSpent('calculator', timeSpent);
            }
        }, 60000); // –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É

        // Initial calculation
        calculateMortgage();

        // Theme handling
        if (tg.colorScheme === 'dark') {
            document.documentElement.style.setProperty('--bg-primary', '#0A0E27');
        }

        // Export analytics data (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
        window.getAnalyticsData = () => {
            return {
                session: analytics.sessionId,
                user: analytics.userId,
                events: analytics.events,
                backup: JSON.parse(localStorage.getItem('analytics_backup') || '[]')
            };
        };
    </script>
</body>
</html>
